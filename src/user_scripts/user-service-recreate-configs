#!/bin/bash
# Пересоздание конфигураций сервисов из шаблонов

USERNAME=$(whoami)
UID=$(id -u)

# Функция проверки и ожидания завершения
wait_for_root_script() {
    echo "Waiting for root script to complete..."

    # Проверяем наличие lock файла
    local lock_file="/tmp/user-services-recreate-$UID.lock"
    local timeout=60
    local count=0

    while [ $count -lt $timeout ] && [ -f "$lock_file" ]; do
        echo -n "."
        sleep 2
        count=$((count + 2))
    done

    if [ -f "$lock_file" ]; then
        echo ""
        echo "Timeout waiting for root script. It may still be running."
        return 1
    fi

    echo ""
    return 0
}

# Основная логика
main() {
    echo "=== Recreating service configurations ==="
    echo "User: $USERNAME (UID: $UID)"
    echo ""

    # Создаем запрос на пересоздание
    local request_file="/tmp/user-services-request-$UID"
    echo "$USERNAME $UID $(date)" > "$request_file"

    echo "1. Request sent to root setup script..."
    echo "2. Root script will run within the next scheduled execution (max 12 hours)"
    echo "3. Or administrator can run it manually"
    echo ""

    # Проверяем есть ли прямой доступ к root скрипту
    if [ -x "/etc/user-services/scripts/create-user-services.sh" ]; then
        read -p "Run configuration update now? (requires sudo) [y/N]: " -n 1 -r
        echo ""
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo "Running configuration update..."
            echo "You may be prompted for sudo password"

            # Создаем lock файл
            local lock_file="/tmp/user-services-recreate-$UID.lock"
            touch "$lock_file"

            # Запускаем root скрипт только для этого пользователя
            sudo /etc/user-services/scripts/create-user-services.sh --user "$USERNAME" 2>&1 | \
                grep -A5 -B5 "$USERNAME" || true

            # Удаляем lock файл
            rm -f "$lock_file"

            echo ""
            echo "Configuration update completed!"
            echo "Reloading user systemd..."
            systemctl --user daemon-reload

            # Показываем статус
            echo ""
            echo "=== Current service status ==="
            systemctl --user status code-server.socket code-server.service nginx-proxy.service --no-pager --lines=5
        fi
    else
        echo "Note: Automatic update requires administrator setup."
        echo "Please contact your system administrator."
    fi

    echo ""
    echo "To apply changes immediately, you can:"
    echo "1. Restart individual services: user-service-control restart <service>"
    echo "2. Reload systemd: systemctl --user daemon-reload"
    echo "3. Check status: user-service-control status"

    # Очищаем request файл
    rm -f "$request_file"
}

# Проверяем что не запущено от root
if [ "$EUID" -eq 0 ]; then
    echo "Error: This script should not be run as root"
    echo "Run as your regular user account"
    exit 1
fi

main "$@"
