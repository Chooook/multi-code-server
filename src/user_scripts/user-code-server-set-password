#!/bin/bash
# Interactive password change for code-server with service restart

USERNAME=$(whoami)
CONFIG_DIR="$HOME/.config/code-server"
CONFIG_FILE="$CONFIG_DIR/config.yaml"
SERVICE_NAME="code-server@$USERNAME.service"

# Check if code-server is configured
if [ ! -f "$CONFIG_FILE" ]; then
    echo "Error: code-server config not found at $CONFIG_FILE"
    echo "Your services might not be set up yet."
    exit 1
fi

echo "=== Code Server Password Change ==="
echo "User: $USERNAME"
echo ""

# Show password requirements
echo "Password requirements:"
echo "- At least 8 characters"
echo "- Can contain letters, numbers, and special characters"
echo ""

# Prompt for new password
read -sp "Enter new password: " password1
echo ""
read -sp "Confirm new password: " password2
echo ""

# Validate
if [ "$password1" != "$password2" ]; then
    echo "Error: Passwords don't match!"
    exit 1
fi

if [ -z "$password1" ]; then
    echo "Error: Password cannot be empty!"
    exit 1
fi

if [ ${#password1} -lt 8 ]; then
    echo "Error: Password must be at least 8 characters!"
    exit 1
fi

# Generate hash and update config
new_hash=$(echo -n "$password1" | sha256sum | cut -d' ' -f1)

# Backup old config
cp "$CONFIG_FILE" "$CONFIG_FILE.backup.$(date +%Y%m%d_%H%M%S)"

# Update config
sed -i "s|^password:.*$|password: $new_hash|" "$CONFIG_FILE"

# Restart code-server service
echo "Restarting code-server service..."
systemctl --user restart "$SERVICE_NAME"

# Verify restart
sleep 2
if systemctl --user is-active --quiet "$SERVICE_NAME"; then
    echo "✓ Password changed successfully!"
    echo "✓ Service restarted and running"

    # Show connection info
    if command -v getent >/dev/null && [ -f "/etc/user-services/ports.db" ]; then
        uid=$(id -u)
        port_line=$(grep "^$uid:" /etc/user-services/ports.db 2>/dev/null | head -1)
        if [ -n "$port_line" ]; then
            codeserver_port=$(echo "$port_line" | cut -d: -f1)
            echo ""
            echo "Connection info:"
            echo "- URL: http://$(hostname -f 2>/dev/null || hostname):$codeserver_port"
            echo "- Or: http://$(hostname -I | awk '{print $1}' 2>/dev/null):$codeserver_port"
        fi
    fi
else
    echo "⚠ Warning: Password changed but service might not be running"
    echo "Check status with: systemctl --user status $SERVICE_NAME"
    echo "Restoring backup..."
    mv "$CONFIG_FILE.backup".* "$CONFIG_FILE" 2>/dev/null
    systemctl --user restart "$SERVICE_NAME"
    exit 1
fi

# Cleanup old backups (keep last 3)
ls -t "$CONFIG_FILE.backup."* 2>/dev/null | tail -n +4 | xargs rm -f 2>/dev/null || true
